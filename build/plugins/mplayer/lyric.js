let t;var e=this&&this.__awaiter||function(t,e,i,s){return new(i||(i=Promise))(function(a,l){function h(t){try{n(s.next(t))}catch(t){l(t)}}function o(t){try{n(s.throw(t))}catch(t){l(t)}}function n(t){t.done?a(t.value):new i(function(e){e(t.value)}).then(h,o)}n((s=s.apply(t,e||[])).next())})};import i from"../../lib/magix.js";import s from"./player.js";let a=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,l=/\[offset\s*:\s*(\d+)\]/i,h=/\[([0-9\.:]+)\]/g,o=(t,e)=>t.time-e.time,n=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],r=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default i.View.extend({tmpl:(e,i,s,a)=>{let l,h,o,n,r=[],{lyrics:_,topmost:c}=e;for(let t=0,e=_,s=e.length;t<s;t++){let s=e[t];o=[i(0,0,a(s.text))],h="xl-aX",s.active&&(h+=" xl-aY"),l=[i("div",{title:a(s.text),class:h},o)],r.push(...l)}return t?l=[t]:(o=[i("path",{fill:"#fff",d:"M511.927 261.389l192.538 192.54H319.388l192.539-192.54zm-76.868 192.588h154.032v231.045H435.059V453.977zM319.535 723.825h385.077v38.51H319.535v-38.51z"},0,1)],l=[t=i("svg",{_:"_",viewBox:"0 0 1024 1024"},o)]),h="xl-aN xl-aZ",c&&(h+=" xl-aP"),n="",n+=c?"\u7a97\u53e3\u5df2\u7f6e\u9876":"\u70b9\u51fb\u7f6e\u9876\u7a97\u53e3",r.push(i("span",{"mx-click":s+"\x1e_aY()","mx-mousedown":s+"\x1e_aX()",class:h,title:n},l)),i(s,0,r)},init(){s.on("_ay",t=>{this._aN(t.song.sid)}),s.on("_aO",t=>{this._aP(t.current)}),s.on("_az",()=>{this._aQ()}),this.set({topmost:!1})},_aQ(){delete this._aR,delete this._aS,delete this._aT,delete this._aU,delete this._aV,this._aP(0)},_aN(t){return e(this,void 0,void 0,function*(){let e=i.mark(this,"_aN");try{let{lyric:i}=yield s._aW(t);e()&&(this._aR=(t=>{let e=0,i=[];return t.replace(l,(t,i)=>(e=parseFloat(i)/1e3,"")).replace(a,(t,s,a)=>{s.replace(h,(t,s)=>{let l=0,h=(s=s.split(":")).length-1;for(let t=0;t<=h;t++)l+=s[t]*Math.pow(60,h-t);l-=e,isNaN(l)||i.push({time:l,text:a})})}),i.length<2&&i.push({time:-1,text:""}),i=i.sort(o)})(i))}catch(t){this._aV=!0}})},_aP(t){let e=this._aR;if(e){let i=0,s=[];for(;i<e.length;i++){if(e[i].time>t)break}let a=Math.ceil(1.5),l=Math.floor(1.5),h=Math.max(i-a,0),o=Math.min(e.length,i+l);if(0==h&&e.length>2&&o-h<3&&o++,o==e.length&&e.length>2&&o-h<3&&h--,(i-=1)<0&&(i=0),this._aT!=o||this._aS!=h||this._aU!=i){this._aT=o,this._aS=h,this._aU=i;for(let t=h;t<o;t++)s.push({text:e[t].text,active:t==i});this.digest({lyrics:s})}}else this.digest({lyrics:this._aV?r:n})},render(){this.digest({lyrics:n})},"_aX<mousedown>"(t){t.stopPropagation()},"_aY<click>"(){let t=!this.get("topmost");this.root.style.zIndex=t?"60000":"",this.digest({topmost:t})}});