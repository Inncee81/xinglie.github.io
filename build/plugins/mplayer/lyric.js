let t;import e from"../../lib/magix.js";import i from"./player.js";let s=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,l=/\[offset\s*:\s*(\d+)\]/i,h=/\[([0-9\.:]+)\]/g,b=(t,e)=>t.time-e.time,o=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],_=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default e.View.extend({tmpl:(e,i,s,l)=>{let h,b,o,_,r=[],{lyrics:a,topmost:n}=e;for(let t=0,e=a,s=e.length;t<s;t++){let s=e[t];o=[i(0,0,l(s.text))],b="xl-bk",s.active&&(b+=" xl-bl"),h=[i("div",{title:l(s.text),class:b},o)],r.push(...h)}return t?h=[t]:(o=[i("path",{fill:"#fff",d:"M511.927 261.389l192.538 192.54H319.388l192.539-192.54zm-76.868 192.588h154.032v231.045H435.059V453.977zM319.535 723.825h385.077v38.51H319.535v-38.51z"},0,1)],h=[t=i("svg",{_:"_",viewBox:"0 0 1024 1024"},o)]),b="xl-ba xl-bm",n&&(b+=" xl-bc"),_="",_+=n?"\u7a97\u53e3\u5df2\u7f6e\u9876":"\u70b9\u51fb\u7f6e\u9876\u7a97\u53e3",r.push(i("span",{"mx-click":s+"\x1e_bk()","mx-mousedown":s+"\x1e_bj()",class:b,title:_},h)),i(s,0,r)},init(){i.on("_aL",t=>{this._b_(t.song.sid)}),i.on("_ba",t=>{this._bb(t.current)}),i.on("_aM",()=>{this._bc()}),this.set({topmost:!1})},_bc(){delete this._bd,delete this._be,delete this._bf,delete this._bg,delete this._bh,this._bb(0)},async _b_(t){let o=e.mark(this,"_b_");try{let{lyric:e}=await i._bi(t);o()&&(this._bd=(t=>{let e=0,i=[];return t.replace(l,(t,i)=>(e=parseFloat(i)/1e3,"")).replace(s,(t,s,l)=>{s.replace(h,(t,s)=>{let h=0,b=(s=s.split(":")).length-1;for(let t=0;t<=b;t++)h+=s[t]*Math.pow(60,b-t);h-=e,isNaN(h)||i.push({time:h,text:l})})}),i.length<2&&i.push({time:-1,text:""}),i=i.sort(b)})(e))}catch(t){this._bh=!0}},_bb(t){let e=this._bd;if(e){let i=0,s=[];for(;i<e.length;i++){if(e[i].time>t)break}let l=Math.ceil(1.5),h=Math.floor(1.5),b=Math.max(i-l,0),o=Math.min(e.length,i+h);if(0==b&&e.length>2&&o-b<3&&o++,o==e.length&&e.length>2&&o-b<3&&b--,(i-=1)<0&&(i=0),this._bf!=o||this._be!=b||this._bg!=i){this._bf=o,this._be=b,this._bg=i;for(let t=b;t<o;t++)s.push({text:e[t].text,active:t==i});this.digest({lyrics:s})}}else this.digest({lyrics:this._bh?_:o})},render(){this.digest({lyrics:o})},"_bj<mousedown>"(t){t.stopPropagation()},"_bk<click>"(){let t=!this.get("topmost");this.root.style.zIndex=t?"60000":"",this.digest({topmost:t})}});