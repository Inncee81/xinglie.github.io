/*!1.0.2 kooboy_li@163.com*/
let t;import e from"../../lib/magix.js";import s from"./player.js";let i=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,l=/\[offset\s*:\s*(\d+)\]/i,h=/\[([0-9\.:]+)\]/g,o=(t,e)=>t.time-e.time,r=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],b=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default e.View.extend({tmpl:(e,s,i,l)=>{let h,o,r,b,_=[],{lyrics:a,topmost:n}=e;for(let t=a.length,e=0;e<t;e++){let t=a[e];r=[s(0,0,l(t.text))],o="xl-bw",t.active&&(o+=" xl-bx"),h=[s("div",{title:l(t.text),class:o},r)],_.push(...h)}return t?h=[t]:(r=[s("path",{fill:"#fff",d:"M511.927 261.389l192.538 192.54H319.388l192.539-192.54zm-76.868 192.588h154.032v231.045H435.059V453.977zM319.535 723.825h385.077v38.51H319.535v-38.51z"},0,0,1)],h=[t=s("svg",{_:"_",viewBox:"0 0 1024 1024"},r)]),o="xl-bm xl-by",n&&(o+=" xl-bo"),b="",b+=n?"\u7a97\u53e3\u5df2\u7f6e\u9876":"\u70b9\u51fb\u7f6e\u9876\u7a97\u53e3",_.push(s("span",{"mx-click":i+"\x1e_bv()","mx-mousedown":i+"\x1e_bu()",class:o,title:b},h)),s(i,0,_)},init(){s.on("_aW",t=>{this._bk(t.song.sid)}),s.on("_bl",t=>{this._bm(t.current)}),s.on("_aX",()=>{this._bn()}),this.set({topmost:!1})},_bn(){delete this._bo,delete this._bp,delete this._bq,delete this._br,delete this._bs,this._bm(0)},async _bk(t){let r=e.mark(this,"_bk");try{let{lyric:e}=await s._bt(t);r()&&(this._bo=(t=>{let e=0,s=[];return t.replace(l,(t,s)=>(e=parseFloat(s)/1e3,"")).replace(i,(t,i,l)=>{i.replace(h,(t,i)=>{let h=0,o=(i=i.split(":")).length-1;for(let t=0;t<=o;t++)h+=i[t]*Math.pow(60,o-t);h-=e,isNaN(h)||s.push({time:h,text:l})})}),s.length<2&&s.push({time:-1,text:""}),s=s.sort(o)})(e))}catch(t){this._bs=!0}},_bm(t){let e=this._bo;if(e){let s=0,i=[];for(;s<e.length;s++){if(e[s].time>t)break}let l=Math.ceil(1.5),h=Math.floor(1.5),o=Math.max(s-l,0),r=Math.min(e.length,s+h);if(0==o&&e.length>2&&r-o<3&&r++,r==e.length&&e.length>2&&r-o<3&&o--,(s-=1)<0&&(s=0),this._bq!=r||this._bp!=o||this._br!=s){this._bq=r,this._bp=o,this._br=s;for(let t=o;t<r;t++)i.push({text:e[t].text,active:t==s});this.digest({lyrics:i})}}else this.digest({lyrics:this._bs?b:r})},render(){this.digest({lyrics:r})},"_bu<mousedown>"(t){t.stopPropagation()},"_bv<click>"(){let t=!this.get("topmost");this.root.style.zIndex=t?"60000":"",this.digest({topmost:t})}});