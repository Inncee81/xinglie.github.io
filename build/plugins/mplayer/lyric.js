let $quick_s_0_static_node;var __awaiter=this&&this.__awaiter||function(t,e,i,a){return new(i||(i=Promise))(function(s,l){function r(t){try{n(a.next(t))}catch(t){l(t)}}function o(t){try{n(a.throw(t))}catch(t){l(t)}}function n(t){t.done?s(t.value):new i(function(e){e(t.value)}).then(r,o)}n((a=a.apply(t,e||[])).next())})};import Magix from"../../lib/magix.js";import Player from"./player.js";let lineReg=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,offsetReg=/\[offset\s*:\s*(\d+)\]/i,timeReg=/\[([0-9\.:]+)\]/g,Sort=(t,e)=>t.time-e.time,MaxLines=3,NoLyric=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],ErrorLyric=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}],ParseLyric=t=>{let e=0,i=[];return t.replace(offsetReg,(t,i)=>(e=parseFloat(i)/1e3,"")).replace(lineReg,(t,a,s)=>{a.replace(timeReg,(t,a)=>{let l=0,r=(a=a.split(":")).length-1;for(let t=0;t<=r;t++)l+=a[t]*Math.pow(60,r-t);l-=e,isNaN(l)||i.push({time:l,text:s})})}),i.length<2&&i.push({time:-1,text:""}),i=i.sort(Sort)};export default Magix.View.extend({tmpl:(t,e,i,a)=>{let s,l,r,o,n=[],{lyrics:h,topmost:_}=t;for(let t=0,i=h,o=i.length;t<o;t++){let o=i[t];r=[e(0,0,a(o.text))],l="xl-aR",o.active&&(l+=" xl-aS"),s=[e("div",{title:a(o.text),class:l},r)],n.push(...s)}return $quick_s_0_static_node?s=[$quick_s_0_static_node]:(r=[e("path",{fill:"#fff",d:"M511.927 261.389l192.538 192.54H319.388l192.539-192.54zm-76.868 192.588h154.032v231.045H435.059V453.977zM319.535 723.825h385.077v38.51H319.535v-38.51z"},0,1)],s=[$quick_s_0_static_node=e("svg",{_:"_",viewBox:"0 0 1024 1024"},r)]),l="xl-aH xl-aT",_&&(l+=" xl-aJ"),o="",o+=_?"\u7a97\u53e3\u5df2\u7f6e\u9876":"\u70b9\u51fb\u7f6e\u9876\u7a97\u53e3",n.push(e("span",{"mx-click":i+"\x1e_aU()","mx-mousedown":i+"\x1e_aT()",class:l,title:o},s)),e(i,0,n)},init(){Player.on("_au",t=>{this._aJ(t.song.sid)}),Player.on("_aK",t=>{this._aL(t.current)}),Player.on("_av",()=>{this._aM()}),this.set({topmost:!1})},_aM(){delete this._aN,delete this._aO,delete this._aP,delete this._aQ,delete this._aR,this._aL(0)},_aJ(t){return __awaiter(this,void 0,void 0,function*(){let e=Magix.mark(this,"_aJ");try{let{lyric:i}=yield Player._aS(t);e()&&(this._aN=ParseLyric(i))}catch(t){this._aR=!0}})},_aL(t){let e=this._aN;if(e){let i=0,a=[];for(;i<e.length;i++){if(e[i].time>t)break}let s=Math.ceil(MaxLines/2),l=Math.floor(MaxLines/2),r=Math.max(i-s,0),o=Math.min(e.length,i+l);if(0==r&&e.length>MaxLines-1&&o-r<MaxLines&&o++,o==e.length&&e.length>MaxLines-1&&o-r<MaxLines&&r--,(i-=1)<0&&(i=0),this._aP!=o||this._aO!=r||this._aQ!=i){this._aP=o,this._aO=r,this._aQ=i;for(let t=r;t<o;t++)a.push({text:e[t].text,active:t==i});this.digest({lyrics:a})}}else this.digest({lyrics:this._aR?ErrorLyric:NoLyric})},render(){this.digest({lyrics:NoLyric})},"_aT<mousedown>"(t){t.stopPropagation()},"_aU<click>"(){let t=!this.get("topmost");this.root.style.zIndex=t?"60000":"2",this.digest({topmost:t})}});