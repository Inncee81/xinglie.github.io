/*!1.0.5 kooboy_li@163.com*/
let t;import e from"../../lib/magix.js";import s from"./player.js";let i=/((?:\[[0-9:\.]+\])+)([^\r\n]*)/g,l=/\[offset\s*:\s*(\d+)\]/i,h=/\[([0-9\.:]+)\]/g,b=(t,e)=>t.time-e.time,r=[{text:""},{text:"\u6b4c\u8bcd\u52a0\u8f7d\u4e2d..."}],o=[{text:""},{text:"\u83b7\u53d6\u6b4c\u8bcd\u5931\u8d25"}];export default e.View.extend({tmpl:(e,s,i,l)=>{let h,b,r,o,_=[],{lyrics:a,topmost:p}=e;for(let t=a.length,e=0;e<t;e++){let t=a[e];r=[s(0,0,l(t.text))],b="xl-bJ",t.active&&(b+=" xl-bK"),h=[s("div",{title:l(t.text),class:b},r)],_.push(...h)}return t?h=[t]:(r=[s("path",{fill:"#fff",d:"M511.927 261.389l192.538 192.54H319.388l192.539-192.54zm-76.868 192.588h154.032v231.045H435.059V453.977zM319.535 723.825h385.077v38.51H319.535v-38.51z"},0,0,1)],h=[t=s("svg",{_:"_",viewBox:"0 0 1024 1024"},r)]),b="xl-bz xl-bL",p&&(b+=" xl-bB"),o="",o+=p?"\u7a97\u53e3\u5df2\u7f6e\u9876":"\u70b9\u51fb\u7f6e\u9876\u7a97\u53e3",_.push(s("span",{"mx-click":i+"\x1e_bA()","mx-mousedown":i+"\x1e_bz()",class:b,title:o},h)),s(i,0,_)},init(){s.on("_ba",t=>{this._bp(t.song.sid)}),s.on("_bq",t=>{this._br(t.current)}),s.on("_bb",()=>{this._bs()}),this.set({topmost:!1})},_bs(){delete this._bt,delete this._bu,delete this._bv,delete this._bw,delete this._bx,this._br(0)},async _bp(t){let r=e.mark(this,"_bp");try{let{lyric:e}=await s._by(t);r()&&(this._bt=(t=>{let e=0,s=[];return t.replace(l,(t,s)=>(e=parseFloat(s)/1e3,"")).replace(i,(t,i,l)=>{i.replace(h,(t,i)=>{let h=0,b=(i=i.split(":")).length-1;for(let t=0;t<=b;t++)h+=i[t]*Math.pow(60,b-t);h-=e,isNaN(h)||s.push({time:h,text:l})})}),s.length<2&&s.push({time:-1,text:""}),s=s.sort(b)})(e))}catch(t){this._bx=!0}},_br(t){let e=this._bt;if(e){let s=0,i=[];for(;s<e.length;s++){if(e[s].time>t)break}let l=Math.ceil(1.5),h=Math.floor(1.5),b=Math.max(s-l,0),r=Math.min(e.length,s+h);if(0==b&&e.length>2&&r-b<3&&r++,r==e.length&&e.length>2&&r-b<3&&b--,(s-=1)<0&&(s=0),this._bv!=r||this._bu!=b||this._bw!=s){this._bv=r,this._bu=b,this._bw=s;for(let t=b;t<r;t++)i.push({text:e[t].text,active:t==s});this.digest({lyrics:i})}}else this.digest({lyrics:this._bx?o:r})},render(){this.digest({lyrics:r})},"_bz<mousedown>"(t){t.stopPropagation()},"_bA<click>"(){let t=!this.get("topmost");this.root.style.zIndex=t?"60000":"",this.digest({topmost:t})}});