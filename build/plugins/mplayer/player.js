import t from"../../lib/magix.js";import e from"../../lib/fetch.js";let i="https://jirenguapi.applinzi.com/fm",s=[],h=[];export default Object.assign({_be:()=>e(`${i}/getChannels.php`,864e5),_bf:t=>fetch(`${i}/getSong.php?channel=${t}`).then(t=>t.json()),_bb:t=>fetch(`${i}/getLyric.php?sid=${t}`).then(t=>t.json()),async _ay(){let{channels:t}=await this._be();return{active:t[0],channels:t}},_bk(e){if(this._bg){clearTimeout(this._bh);let i=this._bi;i||(i={play:!1,buffer:!1});let s=["play","buffer"];for(let h of s)t.has(e,h)||(e[h]=i[h]);this._bi=e,this._bh=setTimeout(()=>{let t=!1;if(i=this._bj){for(let h of s)if(i[h]!=e[h]){t=!0;break}}else t=!0;t&&this.fire("_aD",this._bj=e)},50)}},_bl(){let t=this._bg;if(t){let e=t.buffered,i=0;e.length&&(i=e.end(e.length-1)/t.duration),this.fire("_aU",{duration:t.duration,current:t.currentTime,buffered:i})}},_bp(){if(!this._bg){let t,e=new Audio;e.onprogress=(()=>{this._bl()}),e.onerror=(()=>{clearTimeout(t),t=setTimeout(()=>{this.fire("_aA")},2e3)}),e.onended=(()=>{clearTimeout(t),t=setTimeout(()=>{this.fire("_aA")},1e3)}),e.onvolumechange=(()=>{this.fire("_bm",{volume:e.volume})}),e.oncanplay=(()=>{this._bk({buffer:!1})}),e.onwaiting=(()=>{this._bk({buffer:!0})}),e.ontimeupdate=(()=>{this._bn||this._bl()}),e.onplaying=(()=>{this._bk({play:!0})}),e.ondurationchange=(()=>{this._bn||this._bl()}),e.onpause=(()=>{this._bk({play:e.ended})}),e.onloadedmetadata=(()=>{let t=this._bo,e=!1;for(let i of h)if(i.sid==t.sid){e=!0;break}if(!e)for(let i of s)if(i.sid==t.sid){e=!0;break}e||h.push(t),h.length>50&&h.shift(),this.fire("_aE",{song:t})}),this._bg=e}},_bq(t){this._bp(),this._bg.src=t.url,this._bg.play().catch(t=>{}),this._bo=t},_br(t){if(this._bg){let e=this._bg.seekable,i=e.length;if(i){let s=e.start(0),h=e.end(i-1);t>=s&&t<=h&&(this._bg.currentTime=t)}else{let t=this._bg.buffered;if(t.length){let e=t.end(t.length-1);this._bg.currentTime=e}}}},_bt(t,e,i){clearTimeout(this._bs),this._bs=setTimeout(()=>{this._aB(t,e)},i)},async _aB(e,i){if(this._aJ(),this._bk({buffer:!0}),i||(i=0==s.length),i)try{let s=t.mark(this,"_aB"),{song:h}=await this._bf(e);if(s()){let t=h[0];t.url?(this.fire("_aF",{song:t}),this._bq(t)):this._bt(e,i,50)}}catch(t){this._bt(e,i,2e3)}else{let t=s.pop();h.push(t),this._bq(t),this.fire("_aF",{song:t})}},_aO(){if(h.length>1){this._aJ(),this._bk({buffer:!0});let t=h.pop();s.push(t),t=h[h.length-1],this._bq(t),this.fire("_aF",{song:t})}},_aR(){return this._bg},_aI:()=>h.length>1,_bu(t){this._bg&&(this._bg.volume=t)},_aJ(){this._bg&&this._bg.pause()},_aK(){this._bg&&this._bg.play()},_bv(){let t=this._bg;return!!t&&(t.muted=!t.muted,t.muted)},_aC(){this._bg&&(this._bg.currentTime=0,this._bg.play())},_aG(){if(h.length>1){let t=h[h.length-2];return"\u4e0a\u4e00\u9996\uff1a"+t.title+"-"+t.artist}return"\u4e0a\u4e00\u9996\uff1a\u6682\u65e0\u5386\u53f2\u6b4c\u66f2"},_aH(){if(s.length){let t=s[s.length-1];return"\u4e0b\u4e00\u9996\uff1a"+t.title+"-"+t.artist}return"\u4e0b\u4e00\u9996\uff1a\u968f\u673a\u6b4c\u66f2"},_aS(t){this._bn=t,t||this._bl()}},t.Event);